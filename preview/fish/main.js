(()=>{"use strict";class e{static debounce(e,t){let s;return(...i)=>{clearTimeout(s),s=setTimeout((()=>{clearTimeout,e(...i)}),t)}}static setIdle(e,t){let s=!1;const i=()=>{this.idleCounter>t&&!s?(s=!0,e()):(s=!1,this.idleCounter+=100),setTimeout(i,100)};i()}static notIdle(){this.idleCounter=0}static timeout(e){return new Promise((t=>setTimeout(t,e)))}static isURL(e){return e.length<2083&&/^(http:\/\/www\.|https:\/\/www\.|http:\/\/|https:\/\/)?[a-z0-9]+([\-\.]{1}[a-z0-9]+)*\.[a-z]{2,6}(:[0-9]{1,5})?(\/.*)?$/gi.test(e)}}e.idleCounter=0;class t{static query(e){return document.querySelector(e)}static queryAll(e){return document.querySelectorAll(e)}}var s=function(e,t,s,i){return new(s||(s=Promise))((function(n,o){function a(e){try{r(i.next(e))}catch(e){o(e)}}function l(e){try{r(i.throw(e))}catch(e){o(e)}}function r(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(a,l)}r((i=i.apply(e,t||[])).next())}))};HTMLElement.prototype.addClass=function(e){this.classList.contains(e)||this.classList.add(e)},HTMLElement.prototype.removeClass=function(e){this.classList.contains(e)&&this.classList.remove(e)},HTMLElement.prototype.toggleClass=function(e){this.classList.contains(e)?this.classList.remove(e):this.classList.add(e)},(new class{constructor(){this.width=38976,this.height=2008,this.isTail=!1}start(){return s(this,void 0,void 0,(function*(){yield this.waitDocumentReady();const t=yield this.getResource();this.width=t.width,this.height=t.height,this.initialCanvasSize(),(yield this.applyResource(t))?(yield e.timeout(500),this.enableStartButton(),this.enableHomeButton(),location.search.includes("scrolloverride")&&this.enableSwipeOverride()):this.showErrorMessage()}))}showErrorMessage(){t.query(".loading-title").textContent="资源加载失败！请您尝试刷新页面。",t.query(".loading-count").addClass("hidden"),t.query(".loading-refresh").removeClass("hidden"),t.query(".loading-refresh").onclick=()=>s(this,void 0,void 0,(function*(){location.reload()}))}enableSwipeOverride(){t.query("html").style.scrollBehavior="auto";let e=0,s=0,i=0,n=0;window.addEventListener("touchstart",(t=>{e=t.touches[0].pageX,s=t.touches[0].pageY})),window.addEventListener("touchmove",(t=>{t.preventDefault(),i=t.changedTouches[0].pageX,n=t.changedTouches[0].pageY;const o=i-e,a=n-s;document.scrollingElement&&document.scrollingElement.scrollBy(-1*o,-1*a)}),{passive:!1})}setMusic(){const e=t.query("#bgm");if(e.paused)try{e.currentTime=0,e.volume=.2,e.play()}catch(e){}else e.volume=.2}playMusic(){const e=()=>{document.removeEventListener("touchstart",e);const s=t.query("#bgm");s.volume=0,s.play()};document.addEventListener("touchstart",e,!1)}toggleFullScreen(){document.documentElement.requestFullscreen&&(document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen():document.documentElement.requestFullscreen())}enableHomeButton(){t.query(".home-button").onclick=e=>{e.preventDefault(),document.scrollingElement&&(document.scrollingElement.scrollLeft=0)}}enableAutoPlayButton(){const i=t.query(".loading-autoplay");i.onclick=()=>s(this,void 0,void 0,(function*(){i.addClass("hidden"),t.query(".loading-button").click(),yield e.timeout(5e3),this.startAutoPlayInterval()})),i.removeClass("hidden")}startAutoPlayInterval(){const e=setInterval((()=>{this.isTail?clearInterval(e):window.scrollBy({top:0,left:10,behavior:"smooth"})}),10)}enableStartButton(){const i=t.query("#nav-loading"),n=t.query(".loading-button");t.query(".loading-title").textContent="媒体资源加载成功！",n.onclick=()=>s(this,void 0,void 0,(function*(){n.addClass("hidden"),i.addClass("hidden"),t.query("#canvas-main").removeClass("loading"),this.setScrollEvent(),this.setIntersectionObserver(),this.startAnimation(),yield e.timeout(1e3),this.setMusic(),i.remove()})),t.query(".loading-count").addClass("hidden"),n.removeClass("hidden")}startAnimation(){const s=t.query("#overlay"),i=t.query(".indicator-slide"),n=t.query(".indicator-home"),o=window.scrollX,a=o+window.innerWidth-window.document.body.scrollWidth;s.removeClass("head"),s.removeClass("tail"),o<10?(this.isTail=!1,s.addClass("head"),i.style.display="block"):a>-10?(this.isTail=!0,s.addClass("tail"),i.style.display="none"):(i.style.display="block",this.isTail=!1),a>-25?n.removeClass("hidden"):n.addClass("hidden"),i.addClass("hidden"),this.checkScrollEffect(o/(window.document.body.scrollWidth-window.innerWidth)),t.queryAll('[data-ani="instant"]').forEach((e=>{e.addClass("active")})),e.setIdle((()=>{i.removeClass("hidden")}),5e3)}setScrollEvent(){const s=t.query("body"),i=t.query("#overlay"),n=t.query(".indicator-slide"),o=t.query(".indicator-home");s.style.overflow="auto",s.style.width="auto",s.style.height="auto",window.addEventListener("scroll",(()=>{const t=window.scrollX,s=t+window.innerWidth-window.document.body.scrollWidth;i.removeClass("head"),i.removeClass("tail"),t<10?(this.isTail=!1,i.addClass("head"),o.addClass("hidden"),n.style.display="block"):s>-10?(this.isTail=!0,i.addClass("tail"),o.addClass("hidden"),n.style.display="none"):(o.removeClass("hidden"),n.style.display="block",this.isTail=!1),s>-25?o.removeClass("hidden"):o.addClass("hidden"),n.addClass("hidden"),this.checkScrollEffect(t/(window.document.body.scrollWidth-window.innerWidth)),e.notIdle()}),!1)}checkScrollEffect(e){t.queryAll("[data-sccfx]").forEach((t=>{let s=t.getAttribute("data-sccfx");s&&(t.style.transform=`translate(${e*parseInt(s)}em,0)`)}))}setIntersectionObserver(){const e=new IntersectionObserver((s=>{s.forEach((s=>{if(s.intersectionRatio>0){const i=s.target;if(i.addClass("active"),i.hasAttribute("data-with")){const e=t.queryAll(`[data-trg="${i.getAttribute("data-id")}"]`);e&&e.forEach((e=>e.addClass("active")))}e.unobserve(i)}}))}));t.queryAll('[data-trg="scrollin"]').forEach((t=>{e.observe(t)}))}initialCanvasSize(){t.query("#container-main").style.fontSize=100/this.height+"vh";const e=t.query("#canvas-main");e.style.width=`${this.width}em`,e.style.height=`${this.height}em`}applyResource(i){return new Promise((n=>s(this,void 0,void 0,(function*(){const s=t.query("#bgm");i.music&&(s.src=i.music,this.playMusic());const o=t.query(".loading-count>span"),a=i.origin;let l=0,r=0,d=0;for(i.elements.forEach((e=>{let s=e.name,i=t.queryAll(`[data-id='${s}']`);i&&i.forEach((t=>{l++;const s=e.rdm_x?e.x+Math.round((1-2*Math.random())*e.rdm_x):e.x,i=e.rdm_y?e.y+Math.round((1-2*Math.random())*e.rdm_y):e.y;let n=new Image;n.onload=()=>{r++,o.textContent=`${Math.floor(r/l*100)}%`},n.onerror=e=>{d++},n.src=a+e.path,n.width=e.width,n.height=e.height,n.style.width=`${e.width}em`,n.style.height=`${e.height}em`,e.opacity&&(n.style.opacity=e.opacity.toString()),t.style.left=`${s}em`,t.style.top=`${i}em`,t.appendChild(n)}))}));r<l;){if(d)return n(!1);yield e.timeout(100)}n(!0)}))))}waitDocumentReady(){return new Promise((e=>{if("complete"===document.readyState||"interactive"===document.readyState)e(!0);else{const t=()=>{document.removeEventListener("DOMContentLoaded",t),e(!0)};document.addEventListener("DOMContentLoaded",t)}}))}getResource(){return new Promise(((e,t)=>{fetch("resource.json").then((e=>e.json())).then((t=>{e(t)})).catch((e=>{t(e)}))}))}}).start()})();