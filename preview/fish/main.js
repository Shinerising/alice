(()=>{"use strict";class t{static debounce(t,e){let s;return(...i)=>{clearTimeout(s),s=setTimeout((()=>{clearTimeout,t(...i)}),e)}}static setIdle(t,e){let s=!1;const i=()=>{this.idleCounter>e&&!s?(s=!0,t()):(s=!1,this.idleCounter+=100),setTimeout(i,100)};i()}static notIdle(){this.idleCounter=0}static timeout(t){return new Promise((e=>setTimeout(e,t)))}static isURL(t){return t.length<2083&&/^(http:\/\/www\.|https:\/\/www\.|http:\/\/|https:\/\/)?[a-z0-9]+([\-\.]{1}[a-z0-9]+)*\.[a-z]{2,6}(:[0-9]{1,5})?(\/.*)?$/gi.test(t)}}t.idleCounter=0;class e{static query(t){return document.querySelector(t)}static queryAll(t){return document.querySelectorAll(t)}}var s=function(t,e,s,i){return new(s||(s=Promise))((function(n,o){function a(t){try{d(i.next(t))}catch(t){o(t)}}function l(t){try{d(i.throw(t))}catch(t){o(t)}}function d(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(a,l)}d((i=i.apply(t,e||[])).next())}))};HTMLElement.prototype.addClass=function(t){this.classList.contains(t)||this.classList.add(t)},HTMLElement.prototype.removeClass=function(t){this.classList.contains(t)&&this.classList.remove(t)},HTMLElement.prototype.toggleClass=function(t){this.classList.contains(t)?this.classList.remove(t):this.classList.add(t)},(new class{constructor(){this.width=38976,this.height=2008,this.isTail=!1}start(){return s(this,void 0,void 0,(function*(){yield this.waitDocumentReady();const e=yield this.getResource();this.width=e.width,this.height=e.height,this.initialCanvasSize(),(yield this.applyResource(e))?(yield t.timeout(500),this.enableStartButton(),this.enableHomeButton()):this.showErrorMessage()}))}showErrorMessage(){e.query(".loading-title").textContent="资源加载失败！请您尝试刷新页面。",e.query(".loading-count").addClass("hidden"),e.query(".loading-refresh").removeClass("hidden"),e.query(".loading-refresh").onclick=()=>s(this,void 0,void 0,(function*(){location.reload()}))}setMusic(){const t=e.query("#bgm");if(t.paused)try{t.currentTime=0,t.volume=.2,t.play()}catch(t){}else t.volume=.2}playMusic(){const t=()=>{document.removeEventListener("touchstart",t);const s=e.query("#bgm");s.volume=0,s.play()};document.addEventListener("touchstart",t,!1)}toggleFullScreen(){document.documentElement.requestFullscreen&&(document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen():document.documentElement.requestFullscreen())}enableHomeButton(){e.query(".home-button").onclick=t=>{t.preventDefault(),document.scrollingElement&&(document.scrollingElement.scrollLeft=0)}}enableAutoPlayButton(){const i=e.query(".loading-autoplay");i.onclick=()=>s(this,void 0,void 0,(function*(){i.addClass("hidden"),e.query(".loading-button").click(),yield t.timeout(5e3),this.startAutoPlayInterval()})),i.removeClass("hidden")}startAutoPlayInterval(){const t=setInterval((()=>{this.isTail?clearInterval(t):window.scrollBy({top:0,left:10,behavior:"smooth"})}),10)}enableStartButton(){const i=e.query("#nav-loading"),n=e.query(".loading-button");e.query(".loading-title").textContent="媒体资源加载成功！",n.onclick=()=>s(this,void 0,void 0,(function*(){n.addClass("hidden"),i.addClass("hidden"),e.query("#canvas-main").removeClass("loading"),this.setScrollEvent(),this.setIntersectionObserver(),this.startAnimation(),yield t.timeout(1e3),this.setMusic(),i.remove()})),e.query(".loading-count").addClass("hidden"),n.removeClass("hidden")}startAnimation(){const s=e.query("#overlay"),i=e.query(".indicator-slide"),n=e.query(".indicator-home"),o=window.scrollX,a=o+window.innerWidth-window.document.body.scrollWidth;s.removeClass("head"),s.removeClass("tail"),o<10?(this.isTail=!1,s.addClass("head"),i.style.display="block"):a>-10?(this.isTail=!0,s.addClass("tail"),i.style.display="none"):(i.style.display="block",this.isTail=!1),a>-25?n.removeClass("hidden"):n.addClass("hidden"),i.addClass("hidden"),this.checkScrollEffect(o/(window.document.body.scrollWidth-window.innerWidth)),e.queryAll('[data-ani="instant"]').forEach((t=>{t.addClass("active")})),t.setIdle((()=>{i.removeClass("hidden")}),5e3)}setScrollEvent(){const s=e.query("body"),i=e.query("#overlay"),n=e.query(".indicator-slide"),o=e.query(".indicator-home");s.style.overflow="auto",s.style.width="auto",s.style.height="auto",window.addEventListener("scroll",(()=>{const e=window.scrollX,s=e+window.innerWidth-window.document.body.scrollWidth;i.removeClass("head"),i.removeClass("tail"),e<10?(this.isTail=!1,i.addClass("head"),o.addClass("hidden"),n.style.display="block"):s>-10?(this.isTail=!0,i.addClass("tail"),o.addClass("hidden"),n.style.display="none"):(o.removeClass("hidden"),n.style.display="block",this.isTail=!1),s>-25?o.removeClass("hidden"):o.addClass("hidden"),n.addClass("hidden"),this.checkScrollEffect(e/(window.document.body.scrollWidth-window.innerWidth)),t.notIdle()}),!1)}checkScrollEffect(t){e.queryAll("[data-sccfx]").forEach((e=>{let s=e.getAttribute("data-sccfx");s&&(e.style.transform=`translate(${t*parseInt(s)}em,0)`)}))}setIntersectionObserver(){const t=new IntersectionObserver((s=>{s.forEach((s=>{if(s.intersectionRatio>0){const i=s.target;if(i.addClass("active"),i.hasAttribute("data-with")){const t=e.queryAll(`[data-trg="${i.getAttribute("data-id")}"]`);t&&t.forEach((t=>t.addClass("active")))}t.unobserve(i)}}))}));e.queryAll('[data-trg="scrollin"]').forEach((e=>{t.observe(e)}))}initialCanvasSize(){e.query("#container-main").style.fontSize=100/this.height+"vh";const t=e.query("#canvas-main");t.style.width=`${this.width}em`,t.style.height=`${this.height}em`}applyResource(i){return new Promise((n=>s(this,void 0,void 0,(function*(){const s=e.query("#bgm");i.music&&(s.src=i.music,this.playMusic());const o=e.query(".loading-count>span"),a=i.origin;let l=0,d=0,r=0;for(i.elements.forEach((t=>{let s=t.name,i=e.queryAll(`[data-id='${s}']`);i&&i.forEach((e=>{l++;const s=t.rdm_x?t.x+Math.round((1-2*Math.random())*t.rdm_x):t.x,i=t.rdm_y?t.y+Math.round((1-2*Math.random())*t.rdm_y):t.y;let n=new Image;n.onload=()=>{d++,o.textContent=`${Math.floor(d/l*100)}%`},n.onerror=t=>{r++},n.src=a+t.path,n.width=t.width,n.height=t.height,n.style.width=`${t.width}em`,n.style.height=`${t.height}em`,t.opacity&&(n.style.opacity=t.opacity.toString()),e.style.left=`${s}em`,e.style.top=`${i}em`,e.appendChild(n)}))}));d<l;){if(r)return n(!1);yield t.timeout(100)}n(!0)}))))}waitDocumentReady(){return new Promise((t=>{if("complete"===document.readyState||"interactive"===document.readyState)t(!0);else{const e=()=>{document.removeEventListener("DOMContentLoaded",e),t(!0)};document.addEventListener("DOMContentLoaded",e)}}))}getResource(){return new Promise(((t,e)=>{fetch("resource.json").then((t=>t.json())).then((e=>{t(e)})).catch((t=>{e(t)}))}))}}).start()})();